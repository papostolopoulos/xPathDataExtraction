<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title>How Performant - Test the performance of JavaScript functions</title>
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>

    <style media="screen">
      *{
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: sans-serif;
      }

      #main{
        display: grid;
        grid-template-columns: 33.3% 66.6%;
        grid-template-rows: 100%;
        grid-template-areas:
        "sectionPasteParams sectionPasteFunctions"
        "sectionPasteParams sectionPasteFunctions";
        height: 95vh;
      }

      .sectionPasteParams{
        padding: 10px;
        background-color: lightblue;
        grid-area: sectionPasteParams;
        overflow: auto;
      }

      .divNumOfArgumentsSets{
        position: sticky;
        top: 0;
      }

      #inputNumOfArgumentsSets{
        width: 50px;
      }

      .divArgumentsSets{
        overflow: auto;
      }

      .divFunctionArgument{
        margin-top: 10px;
      }

      .textAreaArgumentsPaste{
        width: 100%;
        height: 10vh;
        padding: 5px;
        font-size: 0.8em;
      }

      .labelArgumentsDataTypes{
        margin-right: 10px;
      }

      .sectionPasteFunctions{
        grid-area: sectionPasteFunctions;
        display: flex;
        align-content: center;
        justify-content: center;
      }

      .sectionFunction1, .sectionFunction2{
        width: 50%;
      }

      .sectionFunction1{
        background-color: lightgreen;
      }

      .sectionFunction2{
        background-color: pink;
      }

      #footer{
        background: rgb(0,0,0);
        height: 5vh;
        line-height: 5vh;
        text-align: center;
        font-size: 1.4rem;
        border-top: 3px solid black;
        color: white;
      }

      #footer a{
        color: white;
      }
    </style>
  </head>
  <body>
    <div id="container">
      <main id="main">
        <section class="sectionPasteParams">
          <div class="divNumOfArgumentsSets">
            <h1>Function arguments</h1>
            <label class="labelNumOfArgumentsSets">
              Enter number of sets:
              <input type="number"
              name="inputNumOfArgumentsSets"
              id="inputNumOfArgumentsSets"
              v-model="numOfArgumentsSets"
              @change="changeArgumentsArrLength()"
              min="0"
              max="20"
              width="4"
              >
            </label>
          </div>



          <div class="divArgumentsSets" v-for="set in Number(numOfArgumentsSets)">
            <function-arg :id="'argSet' + set"></function-arg>
          </div>

        </section>



        <section class="sectionPasteFunctions">
          <section class="sectionFunction1">
            <h1>Function 1</h1>
            This is for function 1 - sectionFunction1 <br>
          </section>



          <section class="sectionFunction2">
            This is for function 2 - sectionFunction2
          </section>
        </section>


      </main>

      <footer id="footer">
        How Performant? Compare JavaScript functions |
        <a href="http://addeventlistener.xyz" target="_blank">@papostolopoulos</a> |
        May 2019
      </footer>
    </div>






    <script type="text/javascript">

//----Vue component----
      Vue.component('function-arg', {
        props: ["set"],
        data(){
          return {
            errorEntry: false,
            dataType: "string",
            textAreaValues: "",
          }
        },
        methods:{
          textAreaValuesSplit(elem){
            this.errorEntry = false;
            console.log("In the start of the textAreaValuesSplit()");
            let startArr = this.textAreaValues.split("\n");
            let finalArr = [];

            if(this.textAreaValues.length === 0) return;

            //If function selected
            if (this.dataType === "function"){
              console.log("selected data type = function");
              let functionsArr = this.textAreaValues.split(/(?<=\})\s+((?=function)|(?=(var|let|const)\s[A-z_\$]\w*\s*=\s*function))/);
              for (let i = 0; i < functionsArr.length; i++) {
                console.log("Result from function selection before the evalFunction:", functionsArr[i]);
                this.evalFunction(functionsArr[i]) === "error" ? this.errorEntry = true : finalArr.push(this.evalFunction(functionsArr[i]));
              }
            }

            //If object selected
            if (this.dataType === "object"){
              console.log("selected dataType = object");
              let objectsArr = this.textAreaValues.split(/\n(?=\{)/);
              for (let i = 0; i < objectsArr.length; i++) {
                objectsArr[i][0] === "{" ? objectsArr[i] = objectsArr[i] : objectsArr[i] = "{" + objectsArr[i];
                console.log("Result from function selection before the evalFunction:", objectsArr[i]);
                this.evalObject(objectsArr[i]) === "error" ? this.errorEntry = true : finalArr.push(this.evalObject(objectsArr[i]));
              }
            }

            //If string selected - Not sure about this
            if (this.dataType === "string"){
              console.log("selected dataType = string");
              let stringsArr = this.textAreaValues.split(/\n/);

              //Find if there are tildas (`) in the strings. That might mean sentences
              //that are spanning to different lines so they need to be connected
              let pairTildas = this.textAreaValues.replace(/[^`]/g, "").length % 2 === 0;
              if (pairTildas) {
                for (let j = 0; j < stringsArr.length; j++) {
                  if (stringsArr[j][0] === "`" && stringsArr[j][stringsArr[j].length - 1] !== "`") {
                    let replaceStr = stringsArr[j];
                    let elemsCounter = 1;
                    for (var k = j+1; k < stringsArr.length; k++) {
                      replaceStr += stringsArr[k];
                      elemsCounter += 1;
                      if (stringsArr[k][stringsArr[k].length - 1] === "`") {
                        stringsArr.splice(j, elemsCounter, replaceStr);
                        break;
                      }
                    } //End of Second loop (k)

                  }
                } //End of first loop, j
              } //End of if(pairTildas)

              for (let i = 0; i < stringsArr.length; i++) {
                this.evalString(stringsArr[i]) === "error" ? this.errorEntry = true : finalArr.push(this.evalString(stringsArr[i]));
              }

            } //End of if this.dataType === string



            for (let i = 0; i < startArr.length; i++) {
              let el = startArr[i];

              //If array selected
              if (this.dataType === "array")
                this.evalArray(startArr[i]) === "error" ? this.errorEntry = true : finalArr.push(this.evalArray(startArr[i]));
              //If boolean selected
              if (this.dataType === "boolean")
                this.evalBoolean(startArr[i]) === "error" ? this.errorEntry = true : finalArr.push(this.evalBoolean(startArr[i]));
              //If null selected
              if (this.dataType === "null")
                this.evalNull(startArr[i]) === "error" ? this.errorEntry = true : finalArr.push(this.evalNull(startArr[i]));
              //If number selected
              if (this.dataType === "number")
                this.evalNumber(startArr[i]) === "error" ? this.errorEntry = true : finalArr.push(this.evalNumber(startArr[i]));
              //If regexp selected
              if (this.dataType === "regexp")
                this.evalRegExp(startArr[i]) === "error" ? this.errorEntry = true : finalArr.push(this.evalRegExp(startArr[i]));
              if (this.dataType === "undefined")
                this.evalUndefined(startArr[i]) === "error" ? this.errorEntry = true : finalArr.push(this.evalUndefined(startArr[i]));
            } //End of for loop

            return finalArr;
          }, //End of textAreaValuesSplit


          evalArray(arr){
            console.log("In the evalArray for", arr);
            if (arr[0] !== "[" || arr[arr.length-1] !== "]"){
              console.log("In the error");
              this.errorEntry = true;
            }
            else {
              arr = arr.slice(1, arr.length-1);

              console.log("array is sliced", arr);

              //Split the array in commas. Do not split if the comma is part of string
              let arrElms = arr
              .split(/(?<=(true|false|undefined|null|\]|\}|\/([igmsuy]+)?|"|'|`|(?<!.)(\d+\.)?\d+)),\s*(?=(\[|\{|true[,\]]|false[,\]]|undefined[,\/]|null[,\]]|[\/"'`]))/g);
              //["den fevgo", [1,2,3], undefined, null, false, 34, 'I like it']
              console.log("elements are separated:", arrElms);
              for (let i = 0; i < arrElms.length; i++) {
                console.log("Evaluating the element");
                if (this.evalArray(arrElms[i]) !== "error") {
                  arrElms[i] = this.evalArray(arrElms[i]);
                    return;
                }

                if (this.evalBoolean(arrElms[i]) !== "error") {
                  arrElms[i] = this.evalBoolean(arrElms[i]);
                    return;
                }


                if (this.evalFunction(arrElms[i]) !== "error") {
                  arrElms[i] = this.evalFunction(arrElms[i]);
                  return;
                }

                if (this.evalNull(arrElms[i]) !== "error") {
                  arrElms[i] = this.evalNull(arrElms[i]);
                    return;
                }

                if (this.evalNumber(arrElms[i]) !== "error") {
                  arrElms[i] = this.evalNumber(arrElms[i]);
                    return;
                }

                if (this.evalObject(arrElms[i]) !== "error") {
                  arrElms[i] = this.evalObject(arrElms[i]);
                    return;
                }

                if (this.evalRegExp(arrElms[i]) !== "error") {
                  arrElms[i] = this.evalRegExp(arrElms[i]);
                    return;
                }

                if (this.evalString(arrElms[i]) !== "error") {
                  arrElms[i] = this.evalString(arrElms[i]);
                    return;
                }

                if (this.evanUndefined(arrElms[i]) !== "error") {
                  arrElms[i] = this.evanUndefined(arrElms[i]);
                    return;
                }
              } //End of for loop
            } //End of if statement
          }, //End of evalArray



          evalBoolean(el){
            if (el === "true") return true;
            if (el === "false") return false;
            return "error";
          },



          evalFunction(el){
            el = el.trim();
            console.log("In evalFunction. The el in the evaFunction is:", el);

            if (!el.startsWith("function") ||
            !el.search(/(var|let|const)\s[A-z_\$]\w*\s*=\s*\(([A-z_\$]\w*,?\s*)*\)\s*=>/ !== 0) ||
            !el.endsWith("}")) return "error";

            let params = el.slice(el.indexOf("(") + 1, el.indexOf(")")).split(/,\s*/);
            params.push(el.slice(el.indexOf("{") + 1, el.indexOf("}")));
            console.log(params);


            return new Function(...params);
          },



          evalNull(el){
            return el === "null" ? null : "error";
          },



          evalNumber(el){
            return isNaN(Number(el)) ? "error" : Number(el);
          },




          evalObject(el){
            el = el.trim();
            if (!el.startsWith("{") || !el.endsWith("}")) return "error";
            console.log("In eval Object. el is", el, "Need to convert from string to object");

            //Put quotes in the keys of the object so it can pass the JSON.parse
            el = el.replace(/(\{)(\s*)(\w)/g, "$1$2\"$3")
            .replace(/(\w)(\s*)(:)/g, "$1$2\"$3")
            .replace(/(,)(\s*)(\w)/g, "$1$2\"$3");
            console.log("After the replacements, the string is:", el);
            let parsedEl = JSON.parse(el);
            console.log(parsedEl);
            return parsedEl;
          },




          evalRegExp(el){
            let elFlags = el.slice(el.lastIndexOf("/") + 1);
            let flags = "igmsuy";
            let source = el.slice(1, el.lastIndexOf("/"));
            console.log(elFlags, flags, source);

            //The last character is not a /
            if (elFlags === 0 && el.length - 1 !== el.lastIndexOf("/")) return "error";


            //some of the flag characters are incorrect
            if (elFlags.length > 0) {
              for (var i = 0; i < elFlags.length; i++) {
                if (!flags.includes(elFlags[i])) return "error";
              }
            }

            //The first character is not a /
            if (el[0] !== "/") return "error";

            let sourceCheck = source.replace(/[^\(\)\[\]\{\}]/g, "");
            console.log(sourceCheck);

            while (sourceCheck.length > 0) {
              if (/\[\]/.test(sourceCheck) || /\(\)/.test(sourceCheck) || /\{\{/.test(sourceCheck)) {
                sourceCheck = sourceCheck.replace(/\[\]/, "").replace(/\(\)/, "").replace(/\{\}/, "");
              }
              else return "error";
            }



            return new RegExp(source, elFlags);
          },




          evalString(el){
            //Should I be removing the quotes or not?
            //How do I deal with tildas where the breaks are not indicating a
            //line break but rather a continuation of a sentence?
            //Get rid of extra quotation marks that might already exist at the input field
            return el.replace(/^(?:["'`]+)?(.*[^"'`])(?:["'`]+)?\s*$/gm, "$1").trim();
          },




          evalUndefined(el){
            return el === "undefined" ? undefined : "error";
          }

        }, //End of methods
        computed: {
          //Create the ID for the div tag that includes the arguments textArea
          argIdNum(){
            return this.$attrs.id.replace(/[A-z]/g, "");
          }

        },
        template:
        `
          <div class="divFunctionArgument" :key="set">
            <h2>Argument Set {{argIdNum}}</h2>
            <label class="labelArgumentsDataTypes">
              <textarea
                class="textAreaArgumentsPaste"
                placeholder="
                Enter the function's argument.
                If you are entering more than one arguments,
                - in order to run the function several times, -
                separate them with a line break"
                v-model="textAreaValues"
                @keyup="textAreaValuesSplit($event.target.value)">

              </textarea>
            </label>
            <h4>Argument data type:</h4>
            <div class="divLabelDataType">
              <form>
                <label class="labelArgumentsDataTypes">
                  Array:
                  <input type="radio" name="inputRadioDataType" value="array" v-model="dataType" @change="textAreaValuesSplit($event.target.value)">
                </label>
                <label class="labelArgumentsDataTypes">
                  Boolean:
                  <input type="radio" name="inputRadioDataType" value="boolean" v-model="dataType" @change="textAreaValuesSplit($event.target.value)">
                </label>
                <label class="labelArgumentsDataTypes">
                  Null:
                  <input type="radio" name="inputRadioDataType" value="null" v-model="dataType" @change="textAreaValuesSplit($event.target.value)">
                </label>
                <label class="labelArgumentsDataTypes">
                  Number:
                  <input type="radio" name="inputRadioDataType" value="number" v-model="dataType" @change="textAreaValuesSplit($event.target.value)">
                </label>
                <label class="labelArgumentsDataTypes">
                  Object literal:
                  <input type="radio" name="inputRadioDataType" value="object" v-model="dataType" @change="textAreaValuesSplit($event.target.value)">
                </label>
                <label class="labelArgumentsDataTypes">
                  RegExp:
                  <input type="radio" name="inputRadioDataType" value="regexp" v-model="dataType" @change="textAreaValuesSplit($event.target.value)">
                </label>
                <label class="labelArgumentsDataTypes">
                  String:
                  <input type="radio" name="inputRadioDataType" value="string" v-model="dataType" @change="textAreaValuesSplit($event.target.value)">
                </label>
                <label class="labelArgumentsDataTypes">
                  Undefined:
                  <input type="radio" name="inputRadioDataType" value="undefined" v-model="dataType" @change="textAreaValuesSplit($event.target.value)">
                </label>
                <label class="labelArgumentsDataTypes">
                  callback function:
                  <input type="radio" name="inputRadioDataType" value="function" v-model="dataType" @change="textAreaValuesSplit($event.target.value)">
                </label>
              </form>

            </div> <!--End of divLabelDataType-->

            <div class="divErrorEntries">
              <div class="divErrorEntry" v-show="errorEntry === true && dataType === 'array'">
                Incorrect array entry(ies). Make sure you have entered arrays that start and end with
                square brackets - [].
                The values should be separated by a line break and without any extra
                line breaks at the end of the text.
              </div>
              <div class="divErrorEntry" v-show="errorEntry === true && dataType === 'boolean'">
                Incorrect boolean entry(ies). Make sure you have entered only boolean values (true, false).
                The values should be separated by a line break and without any extra
                line breaks at the end of the text.
              </div>
              <div class="divErrorEntry" v-show="errorEntry === true && dataType === 'function'">
                Incorrect function entry(ies). Make sure you have entered the function in
                the correct format, with opening and closing curly braces.
                The values should be separated by a line break and without any extra
                line breaks at the end of the text.
              </div>
              <div class="divErrorEntry" v-show="errorEntry === true && dataType === 'null'">
                Incorrect null entry(ies). Make sure you have entered only null values (null).
                The values should be separated by a line break and without any extra
                line breaks at the end of the text.
              </div>
              <div class="divErrorEntry" v-show="errorEntry === true && dataType === 'number'">
                Incorrect number entry(ies). Make sure you have entered only numeric values (integers or floats).
                The values should be separated by a line break and without any extra
                line breaks at the end of the text.
              </div>
              <div class="divErrorEntry" v-show="errorEntry === true && dataType === 'object'">
                Incorrect object literal entry(ies). Make sure you have entered
                an object that opens and closes with curly braces - {}.
                The values should be separated by a line break and without any extra
                line breaks at the end of the text.
              </div>
              <div class="divErrorEntry" v-show="errorEntry === true && dataType === 'regexp'">
                Incorrect regex entry(ies). Make sure you have entered a regular
                expression that  opens and closes with slashes.
                Make sure that the format of the regex (parenthesis, brackets etc)
                is correct. Make sure that the flags are correct.
                The values should be separated by a line break and without any extra
                line breaks at the end of the text.
              </div>
              <div class="divErrorEntry" v-show="errorEntry === true && dataType === 'undefined'">
                Incorrect undefined entry(ies). Make sure you have entered only "undefined" as a value.
                The values should be separated by a line break and without any extra
                line breaks at the end of the text.
              </div>
            </div>
          </div>
        `
      }); //End of Vue component







//----MAIN VUE INSTANCE----
      let app = new Vue({
        el: "#main",
        data: {
          numOfArgumentsSets: 0,
          argumentsArr: []
        },
        methods: {
          changeArgumentsArrLength(){
            // Access the components through app.$children
            Number(this.numOfArgumentsSets) > this.argumentsArr.length ?
            this.argumentsArr.push("") :
            this.argumentsArr.pop();
          }
        }
      });
    </script>

  </body>
</html>
